<html><head><style type="text/css">@charset "UTF-8";[ng\:cloak],[ng-cloak],[data-ng-cloak],[x-ng-cloak],.ng-cloak,.x-ng-cloak,.ng-hide:not(.ng-hide-animate){display:none !important;}ng\:form{display:block;}</style>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width">
  <base href="../../">
  <title>Documentation</title>
  <link rel="stylesheet" type="text/css" href="../../bower_components/bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="../../bower_components/bootstrap/dist/css/bootstrap-theme.min.css">
  <!-- Flatdoc theme -->
  <link href="../../bower_components/flatdoc/theme-white/style.css" rel="stylesheet">
  <script src="../../bower_components/google-code-prettify/bin/prettify.min.js"></script>
  <link rel="stylesheet" type="text/css" href="../../bower_components/google-code-prettify/bin/prettify.min.css">
  <link rel="stylesheet" type="text/css" href="../../bower_components/font-awesome/css/font-awesome.min.css">
  <!-- DocBase -->
  <link rel="stylesheet" type="text/css" href="../../bower_components/docbase/dist/css/main.min.css">
  <!-- Theme -->
  <link rel="stylesheet" type="text/css" href="styles/theme.css">
  
<script type="text/javascript" async="" src="http://twitter.github.io/typeahead.js/releases/latest/typeahead.bundle.js"></script></head>
<body role="flatdoc" class="no-literate">
  <!-- ngView:  --><div ng-view="" class="ng-scope"><!-- ngInclude: navbarHtml --><nav class="navbar navbar-default navbar-fixed-top ng-scope" ng-include="navbarHtml"><div class="container-fluid ng-scope">
  <div class="navbar-header">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a id="docs-appbase-logo" class="navbar-brand" ng-href="#/" href="#/">
      <img src="./images/docbase.png">
    </a>
  </div>

  <div class="collapse navbar-collapse" id="navbar-collapse">
    <ul class="nav navbar-nav">
      <!-- ngRepeat: folder in map[currentVersion] --><li class="dropdown ng-scope" ng-repeat="folder in map[currentVersion]">
        <a ng-href=../../alpha/commands/index.html class="dropdown-toggle map_folder ng-binding" data-toggle="dropdown" role="button" aria-expanded="false" ng-bind="folder.label" href=../../alpha/commands/index.html>commands</a>
        <ul class="dropdown-menu">
          <!-- ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/append.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/append.html>append</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/auth.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/auth.html>auth</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/bgrewriteaof.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/bgrewriteaof.html>bgrewriteaof</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/bgsave.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/bgsave.html>bgsave</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/bitcount.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/bitcount.html>bitcount</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/bitop.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/bitop.html>bitop</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/bitpos.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/bitpos.html>bitpos</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/blpop.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/blpop.html>blpop</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/brpop.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/brpop.html>brpop</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/brpoplpush.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/brpoplpush.html>brpoplpush</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/client-getname.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/client-getname.html>client-getname</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/client-kill.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/client-kill.html>client-kill</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/client-list.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/client-list.html>client-list</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/client-pause.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/client-pause.html>client-pause</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/client-reply.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/client-reply.html>client-reply</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/client-setname.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/client-setname.html>client-setname</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/cluster-addslots.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/cluster-addslots.html>cluster-addslots</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/cluster-count-failure-reports.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/cluster-count-failure-reports.html>cluster-count-failure-reports</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/cluster-countkeysinslot.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/cluster-countkeysinslot.html>cluster-countkeysinslot</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/cluster-delslots.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/cluster-delslots.html>cluster-delslots</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/commands/cluster-failover.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/cluster-failover.html>cluster-failover</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope ng-hide">
            <a ng-href=../../alpha/commands/index.html ng-bind="file.label" class="ng-binding" href=../../alpha/commands/index.html>index</a>
          </li><!-- end ngRepeat: file in folder.files -->
        </ul>
      </li><!-- end ngRepeat: folder in map[currentVersion] --><li class="dropdown ng-scope" ng-repeat="folder in map[currentVersion]">
        <a ng-href=../../alpha/topics/index.html class="dropdown-toggle map_folder ng-binding" data-toggle="dropdown" role="button" aria-expanded="false" ng-bind="folder.label" href=../../alpha/topics/index.html>topics</a>
        <ul class="dropdown-menu">
          <!-- ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/admin.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/admin.html>admin</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/benchmarks.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/benchmarks.html>benchmarks</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/clients.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/clients.html>clients</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/cluster-spec.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/cluster-spec.html>cluster-spec</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/cluster-tutorial.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/cluster-tutorial.html>cluster-tutorial</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/config.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/config.html>config</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/data-types-intro.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/data-types-intro.html>data-types-intro</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/data-types.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/data-types.html>data-types</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/debugging.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/debugging.html>debugging</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/distlock.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/distlock.html>distlock</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/encryption.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/encryption.html>encryption</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/faq.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/faq.html>faq</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/indexes.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/indexes.html>indexes</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/internals-eventlib.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/internals-eventlib.html>internals-eventlib</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/internals-rediseventlib.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/internals-rediseventlib.html>internals-rediseventlib</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/internals-sds.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/internals-sds.html>internals-sds</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/internals-vm.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/internals-vm.html>internals-vm</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/internals.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/internals.html>internals</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/introduction.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/introduction.html>introduction</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/latency-monitor.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/latency-monitor.html>latency-monitor</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/latency.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/latency.html>latency</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/ldb.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/ldb.html>ldb</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/license.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/license.html>license</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/lru-cache.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/lru-cache.html>lru-cache</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/mass-insert.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/mass-insert.html>mass-insert</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/memory-optimization.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/memory-optimization.html>memory-optimization</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope">
            <a ng-href=../../alpha/topics/notifications.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/notifications.html>notifications</a>
          </li><!-- end ngRepeat: file in folder.files --><li ng-repeat="file in folder.files" data-ng-hide="file.name == 'index'" class="ng-scope ng-hide">
            <a ng-href=../../alpha/topics/index.html ng-bind="file.label" class="ng-binding" href=../../alpha/topics/index.html>index</a>
          </li><!-- end ngRepeat: file in folder.files -->
        </ul>
      </li><!-- end ngRepeat: folder in map[currentVersion] -->
    </ul>

    <ul class="nav navbar-nav navbar-right">
       <li class="dropdown search-dropdown">
        <div class="form-group search-form" data-ng-class="{'open-in':search.length &gt; 0}"><input class="search_field form-control dropdown-toggle appbase-search" type="text" placeholder="search"></div>
      </li>
      <li class="dropdown">
        <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
           <span ng-bind="currentVersion" class="ng-binding">alpha</span> <span class="caret"></span>
        </a>
        <ul class="dropdown-menu version-switcher" role="menu">
          <!-- ngRepeat: version in versions --><li ng-repeat="version in versions" class="ng-scope">
            <a ng-href=../../alpha/commands/append.html ng-bind="version" class="ng-binding" href=../../alpha/commands/append.html>alpha</a>
          </li><!-- end ngRepeat: version in versions -->
        </ul>
      </li>
      <!-- ngIf: docbaseOptions.method == 'github' --><li class="github-star ng-scope" data-ng-if="docbaseOptions.method == 'github'">
        <iframe src="https://ghbtns.com/github-btn.html?user=farhan687&amp;repo=redis&amp;type=star&amp;count=true" frameborder="0" scrolling="0" width="170px" height="20px"></iframe>
      </li><!-- end ngIf: docbaseOptions.method == 'github' -->
      <!-- ngIf: docbaseOptions.method != 'github' -->
    </ul>
  </div><!-- /.navbar-collapse -->
</div><!-- /.container-fluid -->
</nav>
<!-- ngIf: !index --><div role="flatdoc" class="content-root ng-scope" data-ng-if="!index">
  <div class="menubar fixed">
    <div class="menu section" role="flatdoc-menu"><ul><li id="root-item" class="level-0"><ul class="level-1" id="root-list"><li id="redis-mass-insertion-item" class="level-1"><a id="redis-mass-insertion-link" href="../../alpha/topics/mass-insert.html#redis-mass-insertion" class="level-1" pref="#redis-mass-insertion">Redis Mass Insertion</a><ul class="level-2" id="redis-mass-insertion-list"><li id="redis-mass-insertion-use-the-protocol-luke-item" class="level-2"><a id="redis-mass-insertion-use-the-protocol-luke-link" href="../../alpha/topics/mass-insert.html#redis-mass-insertion-use-the-protocol-luke" class="level-2" pref="#redis-mass-insertion-use-the-protocol-luke">Use the protocol, Luke</a></li><li id="redis-mass-insertion-generating-redis-protocol-item" class="level-2"><a id="redis-mass-insertion-generating-redis-protocol-link" href="../../alpha/topics/mass-insert.html#redis-mass-insertion-generating-redis-protocol" class="level-2" pref="#redis-mass-insertion-generating-redis-protocol">Generating Redis Protocol</a></li><li id="redis-mass-insertion-how-the-pipe-mode-works-under-the-hoods-item" class="level-2"><a id="redis-mass-insertion-how-the-pipe-mode-works-under-the-hoods-link" href="../../alpha/topics/mass-insert.html#redis-mass-insertion-how-the-pipe-mode-works-under-the-hoods" class="level-2" pref="#redis-mass-insertion-how-the-pipe-mode-works-under-the-hoods">How the pipe mode works under the hoods</a></li></ul></li></ul></li></ul></div>
  </div>
  <div role="flatdoc-content" class="content"><div class="extra_container"><div class="contributors_header">Contributors<span class="pull-right modified-date">Last Modified On : <a href="https://github.com/farhan687/redis/commit/75a57c6c9a9f100cfeab720e0bac477e9e4e6566">Mar 21, 2016</a></span></div><div class="contributor-container"><a class="contributor" href="https://github.com/farhan687" title="farhan687" target="_blank"><img class="contributor_img img-rounded" src="https://avatars.githubusercontent.com/u/6059027?v=3" alt="farhan687"></a></div></div><div class="clearFix"></div><h1 id="redis-mass-insertion">Redis Mass Insertion</h1><p>Sometimes Redis instances needs to be loaded with big amount of preexisting
or user generated data in a short amount of time, so that millions of keys
will be created as fast as possible.</p><p>This is called a <em>mass insertion</em>, and the goal of this document is to
provide information about how to feed Redis with data as fast as possible.</p><h2 id="redis-mass-insertion-use-the-protocol-luke">Use the protocol, Luke</h2><p>Using a normal Redis client to perform mass insertion is not a good idea
for a few reasons: the naive approach of sending one command after the other
is slow because you have to pay for the round trip time for every command.
It is possible to use pipelining, but for mass insertion of many records
you need to write new commands while you read replies at the same time to
make sure you are inserting as fast as possible.</p><p>Only a small percentage of clients support non-blocking I/O, and not all the
clients are able to parse the replies in an efficient way in order to maximize
throughput. For all this reasons the preferred way to mass import data into
Redis is to generate a text file containing the Redis protocol, in raw format,
in order to call the commands needed to insert the required data.</p><p>For instance if I need to generate a large data set where there are billions
of keys in the form: `keyN -&gt; ValueN’ I will create a file containing the
following commands in the Redis protocol format:</p><pre><code class="prettyprint prettyprinted" style=""><span class="pln">SET </span><span class="typ">Key0</span><span class="pln"> </span><span class="typ">Value0</span><span class="pln">
SET </span><span class="typ">Key1</span><span class="pln"> </span><span class="typ">Value1</span><span class="pln">
</span><span class="pun">...</span><span class="pln">
SET </span><span class="typ">KeyN</span><span class="pln"> </span><span class="typ">ValueN</span></code></pre><p>Once this file is created, the remaining action is to feed it to Redis
as fast as possible. In the past the way to do this was to use the
<code>netcat</code> with the following command:</p><pre><code class="prettyprint prettyprinted" style=""><span class="pun">(</span><span class="pln">cat data</span><span class="pun">.</span><span class="pln">txt</span><span class="pun">;</span><span class="pln"> sleep </span><span class="lit">10</span><span class="pun">)</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> nc localhost </span><span class="lit">6379</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="str">/dev/</span><span class="kwd">null</span></code></pre><p>However this is not a very reliable way to perform mass import because netcat
does not really know when all the data was transferred and can’t check for
errors. In 2.6 or later versions of Redis the <code>redis-cli</code> utility
supports a new mode called <strong>pipe mode</strong> that was designed in order to perform
mass insertion.</p><p>Using the pipe mode the command to run looks like the following:</p><pre><code class="prettyprint prettyprinted" style=""><span class="pln">cat data</span><span class="pun">.</span><span class="pln">txt </span><span class="pun">|</span><span class="pln"> redis</span><span class="pun">-</span><span class="pln">cli </span><span class="pun">--</span><span class="pln">pipe</span></code></pre><p>That will produce an output similar to this:</p><pre><code class="prettyprint prettyprinted" style=""><span class="typ">All</span><span class="pln"> data transferred</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Waiting</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> the </span><span class="kwd">last</span><span class="pln"> reply</span><span class="pun">...</span><span class="pln">
</span><span class="typ">Last</span><span class="pln"> reply received </span><span class="kwd">from</span><span class="pln"> server</span><span class="pun">.</span><span class="pln">
errors</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> replies</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1000000</span></code></pre><p>The redis-cli utility will also make sure to only redirect errors received
from the Redis instance to the standard output.</p><h2 id="redis-mass-insertion-generating-redis-protocol">Generating Redis Protocol</h2><p>The Redis protocol is extremely simple to generate and parse, and is
<a href="../../topics/protocol">Documented here</a>. However in order to generate protocol for
the goal of mass insertion you don’t need to understand every detail of the
protocol, but just that every command is represented in the following way:</p><pre><code class="prettyprint prettyprinted" style=""><span class="pun">*&lt;</span><span class="pln">args</span><span class="pun">&gt;&lt;</span><span class="pln">cr</span><span class="pun">&gt;&lt;</span><span class="pln">lf</span><span class="pun">&gt;</span><span class="pln">
$</span><span class="str">&lt;len&gt;&lt;cr&gt;&lt;lf&gt;</span><span class="pln">
</span><span class="str">&lt;arg0&gt;&lt;cr&gt;&lt;lf&gt;</span><span class="pln">
</span><span class="str">&lt;arg1&gt;&lt;cr&gt;&lt;lf&gt;</span><span class="pln">
</span><span class="pun">...</span><span class="pln">
</span><span class="str">&lt;argN&gt;&lt;cr&gt;&lt;lf&gt;</span></code></pre><p>Where <code>&lt;cr&gt;</code> means “\r” (or ASCII character 13) and <code>&lt;lf&gt;</code> means “\n” (or ASCII character 10).</p><p>For instance the command <strong>SET key value</strong> is represented by the following protocol:</p><pre><code class="prettyprint prettyprinted" style=""><span class="pun">*</span><span class="lit">3</span><span class="str">&lt;cr&gt;&lt;lf&gt;</span><span class="pln">
$3</span><span class="str">&lt;cr&gt;&lt;lf&gt;</span><span class="pln">
SET</span><span class="str">&lt;cr&gt;&lt;lf&gt;</span><span class="pln">
$3</span><span class="str">&lt;cr&gt;&lt;lf&gt;</span><span class="pln">
key</span><span class="str">&lt;cr&gt;&lt;lf&gt;</span><span class="pln">
$5</span><span class="str">&lt;cr&gt;&lt;lf&gt;</span><span class="pln">
value</span><span class="str">&lt;cr&gt;&lt;lf&gt;</span></code></pre><p>Or represented as a quoted string:</p><pre><code class="prettyprint prettyprinted" style=""><span class="str">"*3\r\n$3\r\nSET\r\n$3\r\nkey\r\n$5\r\nvalue\r\n"</span></code></pre><p>The file you need to generate for mass insertion is just composed of commands
represented in the above way, one after the other.</p><p>The following Ruby function generates valid protocol:</p><pre><code class="prettyprint prettyprinted" style=""><span class="kwd">def</span><span class="pln"> gen_redis_proto</span><span class="pun">(*</span><span class="pln">cmd</span><span class="pun">)</span><span class="pln">
    proto </span><span class="pun">=</span><span class="pln"> </span><span class="str">""</span><span class="pln">
    proto </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="str">"*"</span><span class="pun">+</span><span class="pln">cmd</span><span class="pun">.</span><span class="pln">length</span><span class="pun">.</span><span class="pln">to_s</span><span class="pun">+</span><span class="str">"\r\n"</span><span class="pln">
    cmd</span><span class="pun">.</span><span class="pln">each</span><span class="pun">{|</span><span class="pln">arg</span><span class="pun">|</span><span class="pln">
        proto </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="str">"$"</span><span class="pun">+</span><span class="pln">arg</span><span class="pun">.</span><span class="pln">to_s</span><span class="pun">.</span><span class="pln">bytesize</span><span class="pun">.</span><span class="pln">to_s</span><span class="pun">+</span><span class="str">"\r\n"</span><span class="pln">
        proto </span><span class="pun">&lt;&lt;</span><span class="pln"> arg</span><span class="pun">.</span><span class="pln">to_s</span><span class="pun">+</span><span class="str">"\r\n"</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
    proto
</span><span class="kwd">end</span><span class="pln">

puts gen_redis_proto</span><span class="pun">(</span><span class="str">"SET"</span><span class="pun">,</span><span class="str">"mykey"</span><span class="pun">,</span><span class="str">"Hello World!"</span><span class="pun">).</span><span class="pln">inspect</span></code></pre><p>Using the above function it is possible to easily generate the key value pairs
in the above example, with this program:</p><pre><code class="prettyprint prettyprinted" style=""><span class="pun">(</span><span class="lit">0.</span><span class="pun">..</span><span class="lit">1000</span><span class="pun">).</span><span class="pln">each</span><span class="pun">{|</span><span class="pln">n</span><span class="pun">|</span><span class="pln">
    STDOUT</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">gen_redis_proto</span><span class="pun">(</span><span class="str">"SET"</span><span class="pun">,</span><span class="str">"Key#{n}"</span><span class="pun">,</span><span class="str">"Value#{n}"</span><span class="pun">))</span><span class="pln">
</span><span class="pun">}</span></code></pre><p>We can run the program directly in pipe to redis-cli in order to perform our
first mass import session.</p><pre><code class="prettyprint prettyprinted" style=""><span class="pln">$ ruby proto</span><span class="pun">.</span><span class="pln">rb </span><span class="pun">|</span><span class="pln"> redis</span><span class="pun">-</span><span class="pln">cli </span><span class="pun">--</span><span class="pln">pipe
</span><span class="typ">All</span><span class="pln"> data transferred</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Waiting</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> the </span><span class="kwd">last</span><span class="pln"> reply</span><span class="pun">...</span><span class="pln">
</span><span class="typ">Last</span><span class="pln"> reply received </span><span class="kwd">from</span><span class="pln"> server</span><span class="pun">.</span><span class="pln">
errors</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> replies</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1000</span></code></pre><h2 id="redis-mass-insertion-how-the-pipe-mode-works-under-the-hoods">How the pipe mode works under the hoods</h2><p>The magic needed inside the pipe mode of redis-cli is to be as fast as netcat
and still be able to understand when the last reply was sent by the server
at the same time.</p><p>This is obtained in the following way:</p><ul>
<li>redis-cli —pipe tries to send data as fast as possible to the server.</li>
<li>At the same time it reads data when available, trying to parse it.</li>
<li>Once there is no more data to read from stdin, it sends a special <strong>ECHO</strong> command with a random 20 bytes string: we are sure this is the latest command sent, and we are sure we can match the reply checking if we receive the same 20 bytes as a bulk reply.</li>
<li>Once this special final command is sent, the code receiving replies starts to match replies with this 20 bytes. When the matching reply is reached it can exit with success.</li>
</ul><p>Using this trick we don’t need to parse the protocol we send to the server in order to understand how many commands we are sending, but just the replies.</p><p>However while parsing the replies we take a counter of all the replies parsed so that at the end we are able to tell the user the amount of commands transferred to the server by the mass insert session.</p></div>
  <!-- ngIf: docbaseOptions.method == 'github' --><a data-ng-if="docbaseOptions.method == 'github'" class="edit ng-scope" ng-href="https://github.com/farhan687/redis/tree/master/src/alpha/topics/mass-insert.md" target="_blank" href="https://github.com/farhan687/redis/tree/master/src/alpha/topics/mass-insert.md">
    <span class="fa fa-pencil"> Edit</span>
  </a><!-- end ngIf: docbaseOptions.method == 'github' -->
</div><!-- end ngIf: !index -->
<!-- ngIf: index -->
</div>
  <script type="text/javascript" src="../../docbase-config.js"></script>
  <script type="text/javascript" src="../../bower_components/docbase/dist/js/main.unique.js"></script>


</body><script>$(function(){  $('.search-form').searchAppbase('/search-index.json', true); })</script></html>